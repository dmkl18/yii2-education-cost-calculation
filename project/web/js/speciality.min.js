var SpecialityApp=SpecialityApp||{};(function($){"use strict";function sendAjax(mdata,mobject,msuccess,merror){$.ajax({type:"POST",url:mdata.handler,dataType:"json",headers:{"X-Requested-With":"XMLHttpRequest"},data:{sp:mdata.sp},success:function(data){if(data!="no")msuccess.call(mobject,data);else merror.call(mobject)},error:function(){merror.call(mobject)}})}var Speciality=function(settings){this.formId=settings.form;this.itemName=settings.itemName;this.summaryId=settings.summary;this.$stepButtons=$("#"+this.formId+" ."+Speciality.STEP_BUTTONS_CLASS);this.blockSubjectsToPassId=settings.individualBlock;this.handler=settings.handler;this.$buttonSubjectsToPass=$("#"+settings.buttonSubjects);this.visibleBlockSubjectsToPass=false;this.$spChoosen=null;this.$soChoosen=null;this.$evChoosen=null;this.$ltChoosen=null;this.cost=settings.cost;this.summary=null;this.subjectsToPass=null;this.$vcs=settings.vcs?$("#"+settings.vcs):null;this.loadImg=settings.loadImg;$("#"+settings.maxPassed).text(Speciality.MAX_PASSED_SUBJECTS_COUNT);var that=this;$("#"+this.formId+" input[name=CalculateCostForm\\[variantSpeciality\\]]").on("change",function(event){that.chooseSpeciality(event)});$("#"+this.formId+" input[name=CalculateCostForm\\[studyOption\\]]").on("change",function(event){that.chooseStudyOption(event)});$("#"+this.formId+" input[name=CalculateCostForm\\[educationVariant\\]]").on("change",function(event){that.chooseEducationVariant(event)});$("#"+this.formId+" input[name=CalculateCostForm\\[technologyType\\]]").on("change",function(event){that.chooseLearningTechnology(event)});$("#"+this.formId+" ."+this.itemName+"-header").on("click",function(event){that.showHideSection(event)});$("#"+this.formId).on("submit",function(event){that.beforeSubmit(event)});this.$stepButtons.on("click",function(event){that.fixSection(event)});this.$buttonSubjectsToPass.on("click",function(event){that.showSubjectsToPass(event)})};Speciality.HEAD_INFO_CLASS="sp-choosen";Speciality.STEP_BUTTONS_CLASS="sp-step-button";Speciality.SLIDE_TIME=1e3;Speciality.MAX_PASSED_SUBJECTS_COUNT=10;Speciality.prototype.baseChoose=function($tg,$ch,button){if($ch===null){var $section=$tg.parents("."+this.itemName),$sectionButton=this.$stepButtons.eq(button);$section.children("."+this.itemName+"-header").data("confirm",true).removeClass("bg-primary").addClass("bg-success");$sectionButton.prop("disabled",false).removeClass("btn-warning disabled").addClass("btn-success").text($sectionButton.attr("title"))}else{$ch.removeData("chText")}return $tg};Speciality.prototype.chooseSpeciality=function(event){this.$spChoosen=this.baseChoose($(event.target),this.$spChoosen,0);if(this.visibleBlockSubjectsToPass){this.clearBlocSubjectsToPass()}this.$spChoosen.data("chText","Специальность / профиль: "+$.trim($(this.$spChoosen.data("target")).text())+" / "+$.trim($("label[for="+this.$spChoosen.attr("id")+"]").text()));if(this.$vcs){this.$vcs.text(this.$spChoosen.data("countSubjects"))}var $dependentInfo=$(this.$spChoosen.data("dependentSectionHeader")+" ."+Speciality.HEAD_INFO_CLASS);if($dependentInfo.length){$dependentInfo.text("Изменен перечень дисциплин. Дисциплины для перезачета при необходимости требуется выбрать заново").addClass("alert alert-warning")}};Speciality.prototype.chooseStudyOption=function(event){this.$soChoosen=this.baseChoose($(event.target),this.$soChoosen,1);var chText="Дисциплин к изучению: "+$.trim(this.$spChoosen.data("countSubjects"));chText+=this.visibleBlockSubjectsToPass?" (индивидуальная программа)":" (стандартная программа)";this.$soChoosen.data("chText",chText);if(this.$soChoosen.val()==1&&this.visibleBlockSubjectsToPass==true){this.clearBlocSubjectsToPass()}};Speciality.prototype.chooseEducationVariant=function(event){this.$evChoosen=this.baseChoose($(event.target),this.$evChoosen,2);this.$evChoosen.data("chText","Вид обучения: "+$.trim($("label[for="+this.$evChoosen.attr("id")+"]").text()))};Speciality.prototype.chooseLearningTechnology=function(event){this.$ltChoosen=this.baseChoose($(event.target),this.$ltChoosen,3);var chText="Технология обучения: "+$.trim($("label[for="+this.$ltChoosen.attr("id")+"]").text());chText+=" ("+this.$evChoosen.data("countSubjects")+" дисциплин / год)";this.$ltChoosen.data("chText",chText)};Speciality.prototype.fixSection=function(event){event.preventDefault();var $target=$($(event.target).data("place"));var showNext=$target.data("last")?false:true;this.SectionSlideUp($target,showNext)};Speciality.prototype.showHideSection=function(event){var $tg=$(event.currentTarget);if($tg.data("confirm")){if($tg.parent().attr("data-current")=="current-item"){var showNext=this.summary||$tg.data("last")?false:true;this.SectionSlideUp($tg,showNext)}else{var $currentItem=$("#"+this.formId+" ."+this.itemName+"[data-current=current-item] ."+this.itemName+"-header");if($currentItem){if($currentItem.data("confirm")){this.SectionSlideUp($currentItem,false)}else{$currentItem.next().slideUp(Speciality.SLIDE_TIME,function(){$(this).parent().removeAttr("data-current")})}}this.SectionSlideDown($tg)}}};Speciality.prototype.SectionSlideDown=function($target){$target.children("."+Speciality.HEAD_INFO_CLASS).remove();$target.next().slideDown(Speciality.SLIDE_TIME,function(){$(this).parent().attr("data-current","current-item").end().find("input:radio").prop("disabled",false)})};Speciality.prototype.SectionSlideUp=function($target,showNext){var that=this;var $ri=$target.next().find("input:radio").prop("disabled",true),chText=$ri.filter(":checked").data("chText");$target.next().slideUp(Speciality.SLIDE_TIME,function(){$target.append('<p class="'+Speciality.HEAD_INFO_CLASS+'">'+chText+"</p>").parent().removeAttr("data-current");if(+$target.data("last")===1&&!that.summary){that.showSummary()}});if(showNext){this.SectionSlideDown($target.parent().next().children("."+this.itemName+"-header"))}};Speciality.prototype.showSubjectsToPass=function(event){event.preventDefault();$($(event.target).data("target")).prop("checked",true).trigger("change");if(this.$spChoosen){if(this.subjectsToPass===null){this.subjectsToPass=new PassedSubjects(this.blockSubjectsToPassId,"CalculateCostForm[soPassed]",Speciality.MAX_PASSED_SUBJECTS_COUNT)}var value=this.$spChoosen.val();$(event.target).hide().after(this.loadImg);sendAjax({handler:this.handler,sp:value},this,this.successShowSubjectsToPass,this.errorShowSubjectsToPass)}};Speciality.prototype.clearBlocSubjectsToPass=function(){this.visibleBlockSubjectsToPass=false;this.subjectsToPass.clear();this.$buttonSubjectsToPass.css("display","inline-block")};Speciality.prototype.successShowSubjectsToPass=function(data){this.$buttonSubjectsToPass.next().remove();this.visibleBlockSubjectsToPass=true;if(this.subjectsToPass.errorMessageStatus){this.subjectsToPass.hideErrorMessage(true)}this.subjectsToPass.createView(data,this.$spChoosen.data("countSubjects"),this,"changeCountSubjects");this.subjectsToPass.$bl.css("display","block")};Speciality.prototype.errorShowSubjectsToPass=function(){this.$buttonSubjectsToPass.show().next().remove();this.subjectsToPass.errorOfData()};Speciality.prototype.changeCountSubjects=function(event){this.subjectsToPass.changeCountSubjects(event);var chText="Дисциплин к изучению: "+(this.$spChoosen.data("countSubjects")-this.subjectsToPass.passedCount)+" (индивидуальная программа)";this.$soChoosen.data("chText",chText)};Speciality.prototype.showSummary=function($target){var summary=this.getSummary();var countSubjectsByYear=+this.$evChoosen.data("countSubjects");var countPassedSubjects=this.visibleBlockSubjectsToPass?this.subjectsToPass.passedCount:0;var countSubjects=+this.$spChoosen.data("countSubjects")-countPassedSubjects;var info=summary.createData(countSubjects,countSubjectsByYear,+this.$ltChoosen.val(),+this.$evChoosen.val());if(summary.$summary.css("display")=="none"){var that=this;summary.$summary.fadeIn(Speciality.SLIDE_TIME,function(){$("#"+that.formId).on("change","."+that.itemName+"-main input",function(){var type=$(this).attr("type");if(type=="radio"||type=="checkbox")that.showSummary()})})}else{summary.showMessage()}$("#"+this.formId+" input[name=CalculateCostForm\\[course\\]]").val(info[0]);$("#"+this.formId+" input[name=CalculateCostForm\\[term\\]]").val(info[1]);$("#"+this.formId+" input[name=CalculateCostForm\\[cost\\]]").val(info[2])};Speciality.prototype.getSummary=function(){if(this.summary===null){this.summary=new Summary(this.summaryId,this.cost.getCostData())}return this.summary};Speciality.prototype.beforeSubmit=function(event){$("#"+this.formId+" input:radio").prop("disabled",false)};var Summary=function(id,costData){this.$summary=$("#"+id);this.costData=costData;this.$ammount1=$("#"+id+"Amount1");this.$ammount2=$("#"+id+"Amount2");this.$period=$("#"+id+"Period");this.$cost=$("#"+id+"Cost");this.messageStatus=false};Summary.MESSAGE_CLASS="recalculation";Summary.MESSAGE_TIME=7e3;Summary.MAX_SUBJECT_COUNT=45;Summary.prototype.createData=function(count,countForYear,typeTechnology,edVariant){var amount=Math.ceil(count/countForYear),amountText,period=amount,baseCost;this.$ammount1.text(amount);if(count!=Summary.MAX_SUBJECT_COUNT){amountText="1 курс - "+countForYear+" дисциплин"}else{var bc=Math.floor(Summary.MAX_SUBJECT_COUNT/countForYear);var rc=count-bc*countForYear;var bcText=bc<5?bc+" курса":bc+" курсов";amountText=bcText+" - "+countForYear+" дисциплин, "+(bc+1)+" курс - "+rc+" дисциплин"}this.$ammount2.text(amountText);this.$period.text(period);for(var i=0,lt=this.costData.length-1;i<lt;i++){if(typeTechnology==this.costData[i].tech&&(edVariant==this.costData[i].ed||!this.costData[i].ed)){baseCost=this.costData[i].value;break}}if(!baseCost){baseCost=this.costData[lt-1].value}var cost=baseCost*count;this.$cost.text(cost);return[amount,period,cost]};Summary.prototype.showMessage=function(){if(this.messageStatus){this.clearMessage();clearTimeout(this.h)}var that=this;var message="Был выполнен пересчет стоимости.";this.messageStatus=true;this.$summary.find("."+Summary.MESSAGE_CLASS).text(message).removeClass("hide").addClass("show");this.h=setTimeout(function(){that.clearMessage()},Summary.MESSAGE_TIME)};Summary.prototype.clearMessage=function(){this.messageStatus=false;this.$summary.find("."+Summary.MESSAGE_CLASS).text("").removeClass("show").addClass("hide")};var PassedSubjects=function(id,rowName,maxPassedSubjects){this.$bl=$("#"+id);this.$table=$("#"+id+" table");this.$subjectsPassed=$("#"+id+"-passed");this.$subjectsLeft=$("#"+id+"-left");this.tableTemplate='<tr><td><input type="checkbox" id="subject" name="'+rowName+'[]" value="" /></td><td></td></tr>';this.maxPassedSubjects=maxPassedSubjects;this.errorMessageStatus=false;this.passedMessageStatus=false};PassedSubjects.ERROR_CLASS="error-passed";PassedSubjects.ERROR_SHOW_TIME=7e3;PassedSubjects.MAX_PASSED_MESSAGE_CLASS="max-passed";PassedSubjects.MAX_PASSED_SUBJECT_MESSAGE='<p class="'+PassedSubjects.MAX_PASSED_MESSAGE_CLASS+' alert alert-warning">Выбрано максимальное число дисциплин для перезачета</p>';PassedSubjects.prototype.createView=function(data,maxSubjects,ob,obMethod){var template=this.tableTemplate,tmp="",index=template.indexOf("subject")+7,index2=template.indexOf("value")+7,index3=template.lastIndexOf("<td>")+4;for(var i=0,lh=data.length;i<lh;i++){tmp+=template.slice(0,index)+data[i]["id"]+template.slice(index,index2)+data[i]["id"]+template.slice(index2,index3)+'<label for="subject'+data[i]["id"]+'">'+data[i]["name"]+"</label>"+template.slice(index3)}this.passedCount=0;this.leftCount=maxSubjects;this.$table.append(tmp);this.$subjectsPassed.text(this.passedCount);this.$subjectsLeft.text(this.leftCount);var that=this;this.$table.on("change","input:checkbox",function(event){ob?ob[obMethod](event):that.changeCountSubjects(event)})};PassedSubjects.prototype.errorOfData=function(){if(this.errorMessageStatus){this.hideErrorMessage(true)}var that=this;var message="Извините, но при попытке получить данные возникла ошибка. Попробуйте получить данные еще раз.";this.errorMessageStatus=true;this.$bl.before('<p class="'+PassedSubjects.ERROR_CLASS+' bg-danger">'+message+"</p>");this.h=setTimeout(function(){that.hideErrorMessage(false)},PassedSubjects.ERROR_SHOW_TIME)};PassedSubjects.prototype.hideErrorMessage=function(clear){if(clear){clearTimeout(this.h)}var $errorMessage=this.$bl.prev();if($errorMessage.attr("class").indexOf(PassedSubjects.ERROR_CLASS)!==-1){$errorMessage.remove()}this.errorMessageStatus=false};PassedSubjects.prototype.changeCountSubjects=function(event){var i=event.target.checked?1:-1;if(this.passedCount<this.maxPassedSubjects||this.passedCount==this.maxPassedSubjects&&i==-1){this.passedCount+=i;this.leftCount-=i;this.$subjectsPassed.text(this.passedCount);this.$subjectsLeft.text(this.leftCount);if(this.passedCount==this.maxPassedSubjects){this.$table.find("input:not(:checked)").prop("disabled",true);this.$bl.prepend(PassedSubjects.MAX_PASSED_SUBJECT_MESSAGE);this.passedMessageStatus=true}else if(this.passedCount==this.maxPassedSubjects-1&&i==-1){this.$table.find("input").prop("disabled",false);if(this.passedMessageStatus){this.$bl.children("."+PassedSubjects.MAX_PASSED_MESSAGE_CLASS).remove();this.passedMessageStatus=false}}}};PassedSubjects.prototype.clear=function(){this.$table.empty();this.$table.off("change");this.$bl.css("display","none");this.leftCount+=this.passedCount;this.passedCount=0;this.$bl.find("."+PassedSubjects.MAX_PASSED_MESSAGE_CLASS).remove()};var Cost=function(id){this.costId=id;var that=this;$("#"+this.costId+" button").on("click",function(event){that.showHide(event)})};Cost.prototype.showHide=function(event){event.preventDefault();var $target=$(event.target),$area;if(!$target.data("areaVisible")){$area=$("#"+this.costId+" .hide");$target.data("areaVisible",true);$area.removeClass("hide").addClass("show")}else{$area=$("#"+this.costId+" .show");$target.data("areaVisible",false);$area.removeClass("show").addClass("hide")}var ch=$target.text();$target.text($target.attr("data-change-text")).attr("data-change-text",ch)};Cost.prototype.getCostData=function(){var prices=[];$("#"+this.costId+" .price").each(function(){var price={};price.tech=+$(this).data("techType");price.ed=+$(this).data("edView");price.value=+$(this).text();prices.push(price)});return prices};function initializeSpeciality(settings){var loadImg=new Image;loadImg.setAttribute("src",settings.loadImg);loadImg.setAttribute("alt","Loading...");settings.loadImg=loadImg;settings.cost=new Cost(settings.costBlock);return new Speciality(settings)}SpecialityApp.initializeSpeciality=initializeSpeciality})(jQuery);$(document).ready(function(){"use strict";var mySpeciality=SpecialityApp.initializeSpeciality({form:"calc-form",individualBlock:"so-individual",buttonSubjects:"so2-passed",itemName:"calc-item",summary:"calcSummary",handler:"http://speciality/web/index.php/speciality/show-passed-subjects",costBlock:"calcPriceInfo",loadImg:"http://speciality/web/images/loader.gif",vcs:"vcs1",maxPassed:"maxPassed"})});
